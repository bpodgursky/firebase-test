<head>
  <script src="https://www.gstatic.com/firebasejs/5.5.9/firebase.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyB69VADFIrdqOWf3PYMUYKIp7SBqP6ecoA",
      authDomain: "canvas-joy-357.firebaseapp.com",
      databaseURL: "https://canvas-joy-357.firebaseio.com",
      projectId: "canvas-joy-357",
      storageBucket: "canvas-joy-357.appspot.com",
      messagingSenderId: "353505808384"
    };
    firebase.initializeApp(config);
  </script>
</head>

<body>
<h1>To-Do List</h1><h2 id="name"></h2>

<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
  Add Item
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="todoLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="todoLabel">Add Item</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h3>Task Name:</h3>
        <input type="text" class="form-control" id="item-name">
        <h3>Task Description:</h3>
        <input type="text" class="form-control" id="item-description">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" id="save" data-dismiss="modal" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<table class="table">
  <thead>
  <tr>
    <th scope="col">Name</th>
    <th scope="col">Description</th>
    <th scope="col">Delete</th>
  </tr>
  </thead>
  <tbody id="items">
  </tbody>
</table>

</body>

<script>

  var db = firebase.database();

  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {

      console.log(user);
      $("#name").text(user.displayName);

      db.ref('/users/' + user.uid).set({
        name: user.displayName,
        email: user.email
      });

      var items = db.ref('/data/' + user.uid+ '/items');
      items.on('value', function(snapshot) {

        var $items = $("#items");
        $items.empty();

        var vals = snapshot.val();

        for(var key in vals) {
          if (vals.hasOwnProperty(key)) {

            var $done = $("<button>Done!</button>").addClass("btn btn-success");
            $done.click((function(key){
              return function(){
                console.log("deleting "+key);
                db.ref('/data/' + user.uid+ '/items/'+key).remove()
              }
            })(key));

            $items.append($("<tr></tr>")
              .append($("<td></td>").text(key))
              .append($("<td></td>").text(vals[key].description))
              .append($("<td></td>").append($done)));
          }
        }

      });

    } else {
      window.location.href = "index.html"
    }
  });

  $("#save").click(function(){
    var name = $("#item-name").val();
    var description = $("#item-description").val();

    var user = firebase.auth().currentUser;

    var updates = {};
    updates['data/' +  user.uid+'/items/'+name] = {description: description};

    return firebase.database().ref().update(updates);

  })

</script>